{% extends "base.html" %}

{% block title %}My Profile - {{ crew_member.name }} - Maricheck{% endblock %}

{% block content %}
<div class="container py-5">
    <div class="row">
        <div class="col-lg-4">
            <!-- Profile Summary Card -->
            <div class="card shadow-sm border-0 mb-4">
                <div class="card-header bg-navy text-white">
                    <h5 class="mb-0">
                        <i class="fas fa-user me-2"></i>
                        Profile Summary
                    </h5>
                </div>
                <div class="card-body">
                    <div class="text-center mb-3">
                        <div class="profile-avatar bg-sea-green text-white rounded-circle mx-auto mb-3 d-flex align-items-center justify-content-center" style="width: 80px; height: 80px;">
                            <i class="fas fa-user fa-2x"></i>
                        </div>
                        <h5 class="mb-1">{{ crew_member.name }}</h5>
                        <p class="text-muted mb-0">{{ crew_member.rank }}</p>
                        <span class="badge bg-{{ crew_member.get_status_class() }} mt-2">
                            {{ crew_member.get_status_name() }}
                        </span>
                    </div>
                    
                    <hr>
                    
                    <div class="profile-info">
                        <div class="row g-2 mb-2">
                            <div class="col-5 text-muted small">Passport:</div>
                            <div class="col-7 fw-bold small">{{ crew_member.passport }}</div>
                        </div>
                        <div class="row g-2 mb-2">
                            <div class="col-5 text-muted small">Nationality:</div>
                            <div class="col-7 fw-bold small">{{ crew_member.nationality }}</div>
                        </div>
                        <div class="row g-2 mb-2">
                            <div class="col-5 text-muted small">Experience:</div>
                            <div class="col-7 fw-bold small">{{ crew_member.years_experience }} years</div>
                        </div>
                        <div class="row g-2 mb-2">
                            <div class="col-5 text-muted small">Availability:</div>
                            <div class="col-7 fw-bold small">{{ crew_member.availability_date.strftime('%B %d, %Y') }}</div>
                        </div>
                        {% if crew_member.available_port_city %}
                        <div class="row g-2 mb-2">
                            <div class="col-5 text-muted small">Port/City:</div>
                            <div class="col-7 fw-bold small">{{ crew_member.available_port_city }}</div>
                        </div>
                        {% endif %}
                    </div>
                    
                    <hr>
                    
                    <div class="profile-completion">
                        <div class="d-flex justify-content-between align-items-center mb-2">
                            <span class="small fw-bold">Profile Completion</span>
                            <span class="small fw-bold text-{{ 'success' if crew_member.get_profile_completion_percentage() == 100 else 'warning' }}">
                                {{ crew_member.get_profile_completion_percentage() }}%
                            </span>
                        </div>
                        <div class="progress" style="height: 8px;">
                            <div class="progress-bar bg-{{ 'success' if crew_member.get_profile_completion_percentage() == 100 else 'warning' }}" 
                                 style="width: {{ crew_member.get_profile_completion_percentage() }}%"></div>
                        </div>
                        {% if crew_member.get_profile_completion_percentage() < 100 %}
                        <small class="text-muted mt-1 d-block">Upload missing documents to complete your profile</small>
                        {% endif %}
                    </div>
                </div>
            </div>
        </div>
        
        <div class="col-lg-8">
            <!-- Document Upload Section -->
            <div class="card shadow-sm border-0">
                <div class="card-header bg-sea-green text-white">
                    <h5 class="mb-0">
                        <i class="fas fa-file-upload me-2"></i>
                        Document Management
                    </h5>
                </div>
                <div class="card-body">
                    {% if document_form %}
                    <form method="POST" enctype="multipart/form-data" id="documentUploadForm">
                        {{ document_form.hidden_tag() }}
                        
                        <!-- Document Categories -->
                        {% set categories = crew_member.get_document_categories() %}
                        
                        {% for category_key, category in categories.items() %}
                        <div class="document-category mb-4">
                            <h6 class="text-navy border-bottom border-sea-green pb-2 mb-3">
                                <i class="fas fa-{{ 'id-card' if category_key == 'identity' else 'heartbeat' if category_key == 'medical' else 'certificate' if category_key == 'professional' else 'file' }} me-2"></i>
                                {{ category.name }}
                            </h6>
                            
                            <div class="row g-3">
                                {% for doc in category.documents %}
                                <div class="col-md-6">
                                    <div class="document-item border rounded p-3">
                                        <div class="d-flex justify-content-between align-items-start mb-2">
                                            <label class="form-label fw-bold mb-1">
                                                {{ doc.name }}
                                                {% if doc.required %}
                                                    <span class="text-danger">*</span>
                                                {% endif %}
                                            </label>
                                            {% if doc.uploaded %}
                                                <span class="badge bg-success">
                                                    <i class="fas fa-check me-1"></i>
                                                    {{ doc.count }} file{{ 's' if doc.count > 1 else '' }}
                                                </span>
                                            {% else %}
                                                <span class="badge bg-secondary">
                                                    <i class="fas fa-times me-1"></i>
                                                    Missing
                                                </span>
                                            {% endif %}
                                        </div>
                                        
                                        <!-- File Upload Field -->
                                        {% set field = document_form[doc.type] %}
                                        {{ field(class="form-control form-control-sm", multiple=true) }}
                                        <div class="form-text">
                                            {% if doc.type in ['passport', 'government_id', 'photo', 'medical_certificate', 'yellow_fever', 'cdc', 'coc_cop', 'stcw_certificates', 'gmdss_dce', 'sea_agreement'] %}
                                                PDF, JPG, JPEG, PNG files only
                                            {% else %}
                                                PDF, DOC, DOCX files only
                                            {% endif %}
                                        </div>
                                        
                                        <!-- Existing Files -->
                                        {% if doc.files %}
                                        <div class="existing-files mt-2">
                                            <small class="text-muted fw-bold">Uploaded Files:</small>
                                            {% for file in doc.files %}
                                            <div class="file-item d-flex justify-content-between align-items-center mt-1 p-2 bg-light rounded">
                                                <div>
                                                    <small class="fw-bold">{{ file.original_filename }}</small>
                                                    <br>
                                                    <small class="text-muted">{{ file.get_file_size_formatted() }} â€¢ {{ file.upload_date.strftime('%b %d, %Y') }}</small>
                                                </div>
                                                <a href="{{ url_for('uploaded_file', filename=file.filename) }}" 
                                                   class="btn btn-sm btn-outline-primary" target="_blank">
                                                    <i class="fas fa-eye"></i>
                                                </a>
                                            </div>
                                            {% endfor %}
                                        </div>
                                        {% endif %}
                                    </div>
                                </div>
                                {% endfor %}
                            </div>
                        </div>
                        {% endfor %}
                        
                        <div class="d-grid mt-4">
                            {{ document_form.submit(class="btn btn-sea-green btn-lg") }}
                        </div>
                    </form>
                    {% endif %}
                </div>
            </div>
            
            <!-- Contact Information -->
            <div class="card shadow-sm border-0 mt-4">
                <div class="card-header bg-gold text-white">
                    <h5 class="mb-0">
                        <i class="fas fa-info-circle me-2"></i>
                        Important Information
                    </h5>
                </div>
                <div class="card-body">
                    <div class="row g-3">
                        <div class="col-md-6">
                            <div class="info-box p-3 border rounded">
                                <h6 class="text-navy mb-2">
                                    <i class="fas fa-shield-alt me-2"></i>
                                    Document Security
                                </h6>
                                <p class="small text-muted mb-0">
                                    All documents are stored securely and are only accessible to authorized personnel. 
                                    Your private profile link should not be shared with anyone.
                                </p>
                            </div>
                        </div>
                        
                        <div class="col-md-6">
                            <div class="info-box p-3 border rounded">
                                <h6 class="text-navy mb-2">
                                    <i class="fas fa-clock me-2"></i>
                                    Processing Time
                                </h6>
                                <p class="small text-muted mb-0">
                                    Document verification typically takes 2-3 business days. You will be notified 
                                    via email once your documents have been reviewed.
                                </p>
                            </div>
                        </div>
                    </div>
                    
                    <hr class="my-3">
                    
                    <div class="text-center">
                        <p class="mb-2">
                            <strong>Need assistance?</strong> Contact our support team:
                        </p>
                        <div class="d-flex justify-content-center gap-3">
                            <a href="mailto:support@maricheck.com" class="btn btn-outline-navy">
                                <i class="fas fa-envelope me-1"></i>
                                Email Support
                            </a>
                            <a href="tel:+15551234567" class="btn btn-outline-navy">
                                <i class="fas fa-phone me-1"></i>
                                Call Us
                            </a>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_scripts %}
<script>
    // Add loading state to document upload form
    document.getElementById('documentUploadForm').addEventListener('submit', function() {
        const submitBtn = this.querySelector('input[type="submit"]');
        submitBtn.disabled = true;
        submitBtn.value = 'Uploading...';
    });
    
    // Show file count when files are selected
    document.querySelectorAll('input[type="file"][multiple]').forEach(function(input) {
        input.addEventListener('change', function() {
            const fileCount = this.files.length;
            const label = this.closest('.document-item').querySelector('label');
            if (fileCount > 0) {
                label.innerHTML = label.innerHTML.split(' <small>')[0] + ` <small class="text-success">(${fileCount} file${fileCount > 1 ? 's' : ''} selected)</small>`;
            }
        });
    });
</script>
{% endblock %}
